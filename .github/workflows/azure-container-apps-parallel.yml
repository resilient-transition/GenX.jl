name: Parallel GenX Jobs on Azure Container Apps
# Updated: 2025-06-09 - Force cache refresh with robust job naming

on:
  workflow_dispatch:
    inputs:
      blob_container:
        description: 'Azure Blob Storage container name (e.g., genx-data)'
        required: true
        type: string
      case_names:
        description: 'Comma-separated list of case names to run (e.g., kentucky,texas,california)'
        required: true
        type: string
      cpu_cores:
        description: 'CPU cores per job (0.25-2.0)'
        required: false
        default: '1.0'
        type: string
      memory_gb:
        description: 'Memory in GB per job (0.5-4.0)'
        required: false
        default: '2.0'
        type: string
      max_parallel:
        description: 'Maximum parallel jobs'
        required: false
        default: '5'
        type: string
      cleanup_level:
        description: 'Cleanup level: jobs-only, registries, or full'
        required: false
        default: 'jobs-only'
        type: choice
        options:
          - jobs-only
          - registries  
          - full
      force_env_recreate:
        description: 'Force Container App Environment recreation (use only for debugging)'
        required: false
        default: false
        type: boolean
      cleanup_registry:
        description: 'Delete Container Registry after run (true/false)'
        required: false
        default: 'true'
        type: string

env:
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  AZURE_LOCATION: ${{ secrets.AZURE_LOCATION }}
  AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
  AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
  CONTAINER_REGISTRY: genxregistry${{ github.run_number }}
  CONTAINER_APP_ENV: genx-env-${{ github.run_number }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      case-matrix: ${{ steps.parse-cases.outputs.cases }}
      registry-name: ${{ steps.setup-vars.outputs.registry }}
      image-name: ${{ steps.setup-vars.outputs.image }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse case names into matrix
        id: parse-cases
        run: |
          cases="${{ github.event.inputs.case_names }}"
          # Convert comma-separated string to JSON array
          json_array=$(echo "$cases" | jq -R 'split(",") | map(select(length > 0))')
          echo "cases=$json_array" >> $GITHUB_OUTPUT
          echo "Parsed cases: $json_array"

      - name: Setup variables
        id: setup-vars
        run: |
          echo "registry=${{ env.CONTAINER_REGISTRY }}" >> $GITHUB_OUTPUT
          echo "image=${{ env.CONTAINER_REGISTRY }}.azurecr.io/genx:${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Azure Container Registry
        run: |
          az acr create \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --name ${{ env.CONTAINER_REGISTRY }} \
            --sku Basic \
            --admin-enabled true \
            --location ${{ env.AZURE_LOCATION }}

      - name: Build and push Docker image
        run: |
          # Login to ACR
          az acr login --name ${{ env.CONTAINER_REGISTRY }}
          
          # Build and push image
          docker build -t ${{ steps.setup-vars.outputs.image }} .
          docker push ${{ steps.setup-vars.outputs.image }}

      - name: Create Container App Environment
        run: |
          az containerapp env create \
            --name ${{ env.CONTAINER_APP_ENV }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --location ${{ env.AZURE_LOCATION }}

  run-parallel-jobs:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      max-parallel: ${{ fromJson(github.event.inputs.max_parallel) }}
      matrix:
        case: ${{ fromJson(needs.setup.outputs.case-matrix) }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create and run Container App Job
        id: run-job
        run: |
          # Debug: Show initial case name
          echo "=== JOB NAME TRANSFORMATION DEBUG ==="
          echo "Original matrix.case: ${{ matrix.case }}"
          echo "Run number: ${{ github.run_number }}"
          
          # Create Azure-compliant job name (replace underscores with hyphens, ensure < 32 chars)
          CASE_CLEAN=$(echo "${{ matrix.case }}" | tr '_' '-' | tr '[:upper:]' '[:lower:]')
          RUN_NUM="${{ github.run_number }}"
          
          echo "After transformation: $CASE_CLEAN"
          
          # Calculate max case name length (32 - "genx-" - "-" - run_number)
          MAX_CASE_LEN=$((32 - 5 - 1 - ${#RUN_NUM}))
          
          # Truncate case name if too long, keeping meaningful part
          if [ ${#CASE_CLEAN} -gt $MAX_CASE_LEN ]; then
            echo "Case name too long, truncating from ${#CASE_CLEAN} to $MAX_CASE_LEN chars"
            CASE_CLEAN=$(echo "$CASE_CLEAN" | cut -c1-$MAX_CASE_LEN)
          fi
          
          JOB_NAME="genx-${CASE_CLEAN}-${RUN_NUM}"
          
          # Verify final name length and compliance
          echo "Final job name: $JOB_NAME (length: ${#JOB_NAME})"
          echo "=== END DEBUG ==="
          
          if [ ${#JOB_NAME} -gt 32 ]; then
            echo "ERROR: Job name exceeds 32 characters"
            exit 1
          fi
          
          # Get ACR credentials
          ACR_SERVER="${{ needs.setup.outputs.registry-name }}.azurecr.io"
          ACR_USERNAME=$(az acr credential show --name ${{ needs.setup.outputs.registry-name }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ needs.setup.outputs.registry-name }} --query passwords[0].value -o tsv)
          
          # Create Container App Job
          az containerapp job create \
            --name "$JOB_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --environment ${{ env.CONTAINER_APP_ENV }} \
            --image "${{ needs.setup.outputs.image-name }}" \
            --registry-server "$ACR_SERVER" \
            --registry-username "$ACR_USERNAME" \
            --registry-password "$ACR_PASSWORD" \
            --cpu ${{ github.event.inputs.cpu_cores }} \
            --memory ${{ github.event.inputs.memory_gb }}Gi \
            --env-vars \
              AZURE_STORAGE_ACCOUNT=${{ env.AZURE_STORAGE_ACCOUNT }} \
              AZURE_STORAGE_KEY=${{ env.AZURE_STORAGE_KEY }} \
              BLOB_CONTAINER=${{ github.event.inputs.blob_container }} \
              CASE_NAME=${{ matrix.case }} \
            --parallelism 1 \
            --replica-completion-count 1 \
            --replica-retry-limit 2 \
            --replica-timeout 7200

          # Start the job
          EXECUTION_NAME=$(az containerapp job start --name "$JOB_NAME" --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --query name -o tsv)
          echo "execution-name=$EXECUTION_NAME" >> $GITHUB_OUTPUT
          echo "job-name=$JOB_NAME" >> $GITHUB_OUTPUT

      - name: Monitor job execution
        run: |
          JOB_NAME="${{ steps.run-job.outputs.job-name }}"
          EXECUTION_NAME="${{ steps.run-job.outputs.execution-name }}"
          
          echo "Monitoring job: $JOB_NAME, execution: $EXECUTION_NAME"
          
          # Wait for job completion (timeout after 2 hours)
          timeout=7200
          interval=30
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            status=$(az containerapp job execution show \
              --name "$JOB_NAME" \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --execution-name "$EXECUTION_NAME" \
              --query "properties.status" -o tsv 2>/dev/null || echo "Unknown")
            
            echo "[$elapsed s] Job status: $status"
            
            if [ "$status" = "Succeeded" ]; then
              echo "✅ Job completed successfully!"
              exit 0
            elif [ "$status" = "Failed" ]; then
              echo "❌ Job failed!"
              exit 1
            fi
            
            sleep $interval
            elapsed=$((elapsed + interval))
          done
          
          echo "⏰ Job timed out after $timeout seconds"
          exit 1

      - name: Get job logs
        if: always()
        run: |
          JOB_NAME="${{ steps.run-job.outputs.job-name }}"
          EXECUTION_NAME="${{ steps.run-job.outputs.execution-name }}"
          
          echo "Fetching logs for job: $JOB_NAME, execution: $EXECUTION_NAME"
          
          # Get logs and save to file
          az containerapp job execution show \
            --name "$JOB_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --execution-name "$EXECUTION_NAME" \
            --query "properties.template.containers[0].image" -o tsv || true
          
          # Try to get logs
          az containerapp logs show \
            --name "$JOB_NAME" \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --follow false \
            --tail 1000 > "${{ matrix.case }}-logs.txt" || echo "Could not retrieve logs"

      - name: Upload job logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: genx-logs-${{ matrix.case }}
          path: ${{ matrix.case }}-logs.txt
          retention-days: 7

  cleanup:
    needs: [setup, run-parallel-jobs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Cleanup Azure resources
        run: |
          echo "=== Cleaning up deployment-specific resources ==="
          echo "Cleanup level: ${{ github.event.inputs.cleanup_level }}"
          
          # Always delete Container App Jobs from this run
          echo "Deleting Container App Jobs from this deployment..."
          az containerapp job list \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query "[?contains(name, 'genx-') && contains(name, '-${{ github.run_number }}')].name" \
            --output tsv | while read job_name; do
            if [ -n "$job_name" ]; then
              echo "Deleting job: $job_name"
              az containerapp job delete \
                --name "$job_name" \
                --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
                --yes || true
            fi
          done
          
          # Container Registry cleanup based on level
          if [ "${{ github.event.inputs.cleanup_level }}" = "registries" ] || [ "${{ github.event.inputs.cleanup_level }}" = "full" ]; then
            echo "Deleting Container Registry '${{ env.CONTAINER_REGISTRY }}'..."
            az acr delete \
              --name ${{ env.CONTAINER_REGISTRY }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --yes || true
          else
            echo "Keeping Container Registry '${{ env.CONTAINER_REGISTRY }}' (cleanup_level=${{ github.event.inputs.cleanup_level }})"
          fi
          
          # Container App Environment cleanup (only for full cleanup or force recreate)
          if [ "${{ github.event.inputs.cleanup_level }}" = "full" ] || [ "${{ github.event.inputs.force_env_recreate }}" = "true" ]; then
            echo "WARNING: Deleting Container App Environment '${{ env.CONTAINER_APP_ENV }}'..."
            az containerapp env delete \
              --name ${{ env.CONTAINER_APP_ENV }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --yes || true
          else
            echo "Keeping Container App Environment '${{ env.CONTAINER_APP_ENV }}' for reuse (cleanup_level=${{ github.event.inputs.cleanup_level }})"
          fi

  summary:
    needs: [setup, run-parallel-jobs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Job Summary
        run: |
          echo "## GenX Parallel Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cases processed:** ${{ github.event.inputs.case_names }}" >> $GITHUB_STEP_SUMMARY
          echo "**Container:** ${{ github.event.inputs.blob_container }}" >> $GITHUB_STEP_SUMMARY
          echo "**Resources per job:** ${{ github.event.inputs.cpu_cores }} CPU, ${{ github.event.inputs.memory_gb }}GB RAM" >> $GITHUB_STEP_SUMMARY
          echo "**Max parallel:** ${{ github.event.inputs.max_parallel }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results location:** Azure Blob Storage container \`${{ github.event.inputs.blob_container }}\` under \`results/\` folder" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs artifacts for detailed execution information."
